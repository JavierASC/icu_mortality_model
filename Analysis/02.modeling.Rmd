---
title: "Prediction of mortality in ICU at 72 hours"
author: "Javier Quintero Sosa"
date: "2024-04-29"
output: html_document
---

# OBJECTIVE VARIABLE (TARGET)

icu_mortality_72hrs: 0 ALIVE, 1 EXPIRED

# PACKAGE LOADING (install if necessary)
                                                                                                                
```{r message=FALSE, warning=FALSE}

library(caret)
library(bigrquery)
library(bigQueryR)
library(dplyr)
library(forecast)
library(forcats)
library(ggplot2)
library(here)
library(kernlab) #required for SVM
library(knitr)
library(lubridate)
library(plotly)
library(randomForest)
library(rattle)
library(readr)
library(ROCR)
library(rpart)
library(skimr)
library(summarytools)
library(tableone)
library(table1)
library(tidyverse)
library(tidyr)
# library(xlsx)
library(xtable)

#-------------------------------------------------------------------------------

library(gbm)
library(corrplot)
library(cowplot)
library(DBI)
require(boot)
library(data.table)
library(geosphere)
library(GGally)
library(gganimate)
library(ggcorrplot)
library(gifski)
library(gridExtra)
library(hmeasure)
library(Hmisc)
library(janitor)
library(lattice)
library(magrittr)
library(MLeval)
library(mlbench)
library(MLmetrics)
library(naniar)
library(oddsratio)
library(openxlsx)
library(plotrix)
library(plyr)
library(pROC)
require(pROC)
library(psych)
library(RColorBrewer)
library(rpart.plot)
library(scales)
library(SimDesign)
library(simputation)
library(stats)
library(Tmisc)
library(visdat)
library(WVPlots)
library(xgboost)

```


#                     EXTRACT DATAFRAME

In this section, the data, or dataframe, already analyzed and cleaned in the previous stage, is loaded.

```{r message=FALSE, warning=FALSE, paged.print=FALSE}

# 0.LOAD THE DATA

# file.choose()     # Shows the location of the file.

final_df_selected <- read_csv("C:\\Users\\jquintero24E\\Desktop\\Icu_mortality-models\\Icu_mortality-models\\Analysis\\dataframe_2024_04_23.csv")

# Delete first column (count)

final_df_selected <- final_df_selected %>%
  select(-...1)

# 1.STUDY THE DATA

# Column names

colnames(final_df_selected)

# Check that there is no NA in the target variable.

str_glue("The number of NA in the target variable (icu_mortality_72hrs) is {sum(is.na(final_df_selected$icu_mortality_72hrs))}")

# Check the NAs in the entire dataframe.

NA_by_column <- colSums(is.na(final_df_selected))

# View(NA_by_column)

```

# Principal Component Analysis (PCA)

```{r}

# THE DATA MUST BE NUMERIC, NOT FACTOR.

# patientunitstayid and icu_mortality_72hrs are removed as they are not study variables.

final_df_selected_PCA <- final_df_selected %>%
  select(-patientunitstayid, -icu_mortality_72hrs)

# Remove numbedscategory and region (missing values)

final_df_selected_PCA <- final_df_selected %>%
  select(-numbedscategory, -region)

# Apply PCA 

pca_result <- prcomp(final_df_selected_PCA, scale = TRUE) 

# Calculate the percentage of variability explained

porcentaje_var_explicada <- pca_result$sdev^2 / sum(pca_result$sdev^2) * 100

print(porcentaje_var_explicada)

# Here we have the percentage of variability explained by each principal component.

# Create a dataframe with the name of the columns and the percentage of variability explained

resultados_dataframe <- data.frame(Columna = colnames(final_df_selected_PCA), 
                                   Porcentaje_Variabilidad_Explicada = porcentaje_var_explicada)
#---

# Based on these results, we could eliminate the variables with the least explained variability from our dataframe.

```

#             CORRECTION OF THE 0, 1 FACTOR VARIABLES

```{r}

final_df_selected <- final_df_selected %>%
  mutate(
    sex = ifelse(sex == 1, 0, 1),
    norepinephrine = ifelse(norepinephrine == 1, 0, 1),
    phenylephrine = ifelse(phenylephrine == 1, 0, 1),
    heparin = ifelse(heparin == 1, 0, 1),
    warfarin = ifelse(warfarin == 1, 0, 1),
    vasopressors_other_bin = ifelse(vasopressors_other_bin == 1, 0, 1),
    hist_diabetes_bin = ifelse(hist_diabetes_bin == 1, 0, 1),
    hist_chf_bin = ifelse(hist_chf_bin == 1, 0, 1),
    hist_copd_bin = ifelse(hist_copd_bin == 1, 0, 1),
    hist_cancer_bin = ifelse(hist_cancer_bin == 1, 0, 1),
    hist_renal_bin = ifelse(hist_renal_bin == 1, 0, 1),
    hist_other_bin = ifelse(hist_other_bin == 1, 0, 1),
    CABG = ifelse(CABG == 1, 0, 1),
    Cardiac_arrest = ifelse(Cardiac_arrest == 1, 0, 1),
    CHF = ifelse(CHF == 1, 0, 1),
    CVA = ifelse(CVA == 1, 0, 1),
    Diabetic_ketoacidosis = ifelse(Diabetic_ketoacidosis == 1, 0, 1),
    MI = ifelse(MI == 1, 0, 1),
    Rhythm_disturbance = ifelse(Rhythm_disturbance == 1, 0, 1),
    Sepsis_renal = ifelse(Sepsis_renal == 1, 0, 1),
    Sepsis_pulmonary = ifelse(Sepsis_pulmonary == 1, 0, 1),
    apache_other = ifelse(apache_other == 1, 0, 1)
  )


```



#               CHANGE THE COLUMNS BACK TO FACTOR TYPE AGAIN

```{r message=FALSE, warning=FALSE, paged.print=FALSE}

final_df_selected$icu_mortality_72hrs <- as.factor(final_df_selected$icu_mortality_72hrs)

#---
# Rename the levels of the target variable.    icu_mortality_72hrs: 0 ALIVE, 1 EXPIRED

levels(final_df_selected$icu_mortality_72hrs) <- c("Alive", "Expired")

#---

final_df_selected$hist_diabetes_bin <- as.factor(final_df_selected$hist_diabetes_bin)
final_df_selected$hist_chf_bin <- as.factor(final_df_selected$hist_chf_bin)
final_df_selected$hist_copd_bin <- as.factor(final_df_selected$hist_copd_bin)
final_df_selected$hist_cancer_bin <- as.factor(final_df_selected$hist_cancer_bin)
final_df_selected$hist_renal_bin <- as.factor(final_df_selected$hist_renal_bin)
final_df_selected$hist_other_bin <- as.factor(final_df_selected$hist_other_bin)

final_df_selected$CABG <- as.factor(final_df_selected$CABG)
final_df_selected$Cardiac_arrest <- as.factor(final_df_selected$Cardiac_arrest)
final_df_selected$CHF <- as.factor(final_df_selected$CHF)
final_df_selected$CVA <- as.factor(final_df_selected$CVA)
final_df_selected$Diabetic_ketoacidosis <- as.factor(final_df_selected$Diabetic_ketoacidosis)
final_df_selected$MI <- as.factor(final_df_selected$MI)
final_df_selected$Rhythm_disturbance <- as.factor(final_df_selected$Rhythm_disturbance)
final_df_selected$Sepsis_renal <- as.factor(final_df_selected$Sepsis_renal)
final_df_selected$Sepsis_pulmonary <- as.factor(final_df_selected$Sepsis_pulmonary)
final_df_selected$apache_other <- as.factor(final_df_selected$apache_other)

final_df_selected$sex <- as.factor(final_df_selected$sex)

final_df_selected$heparin <- as.factor(final_df_selected$heparin)
final_df_selected$norepinephrine <- as.factor(final_df_selected$norepinephrine)
final_df_selected$warfarin <- as.factor(final_df_selected$warfarin)
final_df_selected$phenylephrine <- as.factor(final_df_selected$phenylephrine)
final_df_selected$vasopressors_other_bin <- as.factor(final_df_selected$vasopressors_other_bin)

final_df_selected$region <- as.factor(final_df_selected$region)
final_df_selected$numbedscategory <- as.factor(final_df_selected$numbedscategory)
final_df_selected$teachingstatus <- as.factor(final_df_selected$teachingstatus)

final_df_selected$ethnicity <- as.factor(final_df_selected$ethnicity)

```


# REDUCTION OF VARIABLES

```{r}

# Manual variable selection: I have decided to add the variables one by one to the dataframe and I have eliminated the variables that lowered the performance of the model (decreased the F1).


# Excluded Variables
# hist_other_bin F1 drops to 0,583
# spo2_clear F1 drops a little
# region has missing values
# numbedscategory has missing values


# Essential Variables (if they are eliminated, the F1 decreases)
# prev_dept_los_hrs
# potassium_clear
# hemoglobin_clear
# final_charlson_score
# Cardiac_arrest 

## I have made a dataframe only with the "Essential" variables, but it is a failure: F1: 0.4066 Successes: 32.749%

## Added: region, numbedscategory, teachingstatus (it reduces success)

final_df_selected <- final_df_selected %>%
  select(patientunitstayid, icu_mortality_72hrs, age, sex, ethnicity, prev_dept_los_hrs, bicarbonate_clear, sodium_clear, respiratoryrate_clear, BUN_clear, nibp_diastolic_clear, nibp_systolic_clear, nibp_mean_clear, temperature_clear, glucose_clear, potassium_clear, hemoglobin_clear, calcium_clear, norepinephrine, phenylephrine, heparin, warfarin, heartrate_clear, vasopressors_other_bin, hist_diabetes_bin, hist_chf_bin, hist_copd_bin, hist_cancer_bin, hist_renal_bin, final_charlson_score, CABG, Cardiac_arrest, CHF, CVA, Diabetic_ketoacidosis, MI, Rhythm_disturbance, Sepsis_renal, Sepsis_pulmonary, apache_other, teachingstatus)

# stview(dfSummary(final_df_selected))

```

Factor variables:

icu_mortality_72hrs (Alive: 0 / Exxpired: 1)
Sex (Male: 0 / Female: 1)
ethnicity (African American: 0 / Asian: 1 / Caucasian: 2 / Hispanic: 3 / Native American: 4 / Other/Unknown: 5)
teachingstatus (FALSE: 0   TRUE: 1)



#                   DIVISION OF THE DF IN TRAIN AND TEST

To train various types of models that can predict a patient's survival based on the data, said data will be divided into two sets: training (train) and testing (test).

```{r message=FALSE, warning=FALSE}


# 0. CHECK BALANCE OR IMBALANCE OF THE DATAFRAME

round(prop.table(table(final_df_selected$icu_mortality_72hrs)),2)

# 1. TRAIN-TEST SELECTION

# Set the seed to make our partition reproducible.
set.seed(13579)

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_selected$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train = final_df_selected[idx_train, ]
data_test  = final_df_selected[-idx_train, ]

# 2. Create a summarytools (train and test)

# stview(dfSummary(data_train))
# stview(dfSummary(data_test))

# 3. SAVE DIVISION TO CSV

#  write.csv(data_test, "data_test_factor_2024_02_29.csv")
#  write.csv(data_train, "data_train_factor_2024_02_29.csv")

```

# ESTABLISH THE FORMULA FOR THE MODEL

A formula of type icu_mortality_72hrs ~ predictor1 + predictor2 + ... is used to train the model.

Only the variables of interest must be selected, as well as the patient ID removed (except in data_test).


```{r message=FALSE, warning=FALSE}

# 1º REMOVE ID FROM data_train AND FROM ORIGINAL DATAFRAME (data_test must have ID)

final_df_selected_without_ID <- final_df_selected %>%
  select(-patientunitstayid)

data_train_without_ID <- data_train %>%
  select(-patientunitstayid)

# At this point you can remove unwanted columns for modeling.

# 2º. MAKE THE MODEL (without including the ID as a variable)

outcome_model <- "icu_mortality_72hrs"                                   
exposures_model <- names(data_train_without_ID)                   
exposures_model <- exposures_model[-which(exposures_model == outcome_model)]   

# Model formula

outcome_and_exposure <- as.formula(paste(outcome_model, "~", paste(exposures_model, collapse = " + "))) 

```

# TABLE FOR COMPARISON TRAIN - TEST

It is verified that the variables included in the model are represented approximately equally in the training and test sets.

```{r message=FALSE, warning=FALSE}

tmp = as.data.frame(final_df_selected_without_ID)
tmp$trainTest = "TestSet"
tmp$trainTest[idx_train] = "TrainingSet"
table1(as.formula(paste0(" ~ ",paste(exposures_model, collapse = " + ")," | trainTest")), data=tmp, overall=F)

```


# HYPERPARAMETER TUNING

This adjustment randomly tests all study models and chooses the one with the best results.

The first thing to do is set the fitcontrol (establish how to evaluate each model).

```{r message=FALSE, warning=FALSE}

fitControl <- trainControl(method = "repeatedcv",
                           number = 10,
                           repeats = 1,
                           classProbs = TRUE,
                           summaryFunction = multiClassSummary,
                           verboseIter = F,
                           search = "random",
                           sampling = "down")

```

# MODEL TRAINING AND BEST MODEL SELECTION

The different models will be trained:

gbm: Gradient Boosting Machine
rf: Random Forest
xgbTree: eXtreme Gradient Boosting
LogitBoost: Boosted Logistic Regression
lda: Linear Discriminant Analysis
kernelpls: Kernel Partial Least Squares
ranger: Random forests
Linda
Rborist: Random Forest

The train() function is used to train the models.

```{r message=FALSE, warning=FALSE}

# Set the seed to make our partition reproducible.
set.seed(123)

# Train the different models.

h_start_gbm <- Sys.time()                          # 9h

fit_gbm <- train(outcome_and_exposure,                 # F1:0.3094  Success:26.203%   
                 data = data_train_without_ID,
                 method = "gbm",               
                 trControl = fitControl,        
                 verbose = F,                   
                 na.action = na.omit,
                 metric = "F1")                 

h_start_rf <- Sys.time()                           # 4h 20 min

fit_rf <- train(outcome_and_exposure,                  # F1:0.2056  Success:21.587%      
                data = data_train_without_ID,
                method = "rf",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

h_start_xgb <- Sys.time()                          # 16 min

fit_xgb <- train(outcome_and_exposure,                # F1:0.3020   Success:25.812%    
                 data = data_train_without_ID,
                 method = "xgbTree",
                 trControl = fitControl,
                 verbose = F,
                 na.action = na.omit,
                 metric = "F1")

h_start_lr <- Sys.time()                           # 5 min 

fit_lr <- train(outcome_and_exposure,                  #F1:0,7536  Success:61,32%
                data = data_train_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

h_start_lda <- Sys.time()                        # 20 seconds             

fit_lda <- train(outcome_and_exposure,               # F1:0.4641  Success:36.616%    
                data = data_train_without_ID,          
                method = "lda",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

h_start_kernelpls <- Sys.time()                  # 35 seconds 

fit_kernelpls <- train(outcome_and_exposure,         # F1:0.4662  Success:36.721%       
                data = data_train_without_ID,
                method = "kernelpls",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

h_start_ranger <- Sys.time() 

fit_ranger <- train(outcome_and_exposure,           # 40 min
                data = data_train_without_ID,
                method = "ranger",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

h_start_Linda <- Sys.time() 

fit_Linda <- train(outcome_and_exposure,            # 1 min
                data = data_train_without_ID,       # F1:0.4932  Success:40.536%  
                method = "Linda",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

# Better to run fit_cforest separately

h_start_cforest <- Sys.time() 

fit_cforest <- train(outcome_and_exposure,       # 1h
                data = data_train_without_ID,    # F1:0,68  Success:53,30%
                method = "Rborist",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

h_end <- Sys.time()

# Total modeling time

# Minutes
minutes_modeling <- as.numeric(difftime(h_end, h_start_gbm, units = "mins"))

# Hours
h_modeling <- as.numeric(difftime(h_end, h_start_gbm, units = "hours"))


#---------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------

# SAVE THE MODELS

saveRDS(fit_gbm, file = "gbm_model.Rda")
saveRDS(fit_rf, file = "rf_model.Rda")
saveRDS(fit_xgb, file = "xgb_model.Rda")
saveRDS(fit_lr, file = "lr_model.Rda") # Runs later again
saveRDS(fit_lda, file = "lda_model.Rda")
saveRDS(fit_kernelpls, file = "kernelpls_model.Rda")
saveRDS(fit_ranger, file = "ranger_model.Rda")
saveRDS(fit_Linda, file = "Linda_model.Rda")
saveRDS(fit_cforest, file = "cforest_model.Rda")

# UPLOAD THE MODELS

# fit_gbm <- readRDS("gbm_model.Rda")
# fit_rf <- readRDS("rf_model.Rda")
# fit_xgb <- readRDS("xgb_model.Rda")
# fit_lr <- readRDS("lr_model.Rda")
# fit_lda <- readRDS("lda_model.Rda")
# fit_kernelpls <- readRDS("kernelpls_model.Rda")
# fit_ranger <- readRDS("ranger_model.Rda")
# fit_Linda <- readRDS("Linda_model.Rda")
# fit_cforest <- readRDS("cforest_model.Rda")

#---------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------

# STATISTICS SUMMARY

resamps <- resamples(list(fit_gbm = fit_gbm,
                          fit_rf  = fit_rf,
                          fit_xgb = fit_xgb,
                          fit_lr  = fit_lr,
                          fit_lda = fit_lda,
                          fit_kernelpls = fit_kernelpls,
                          fit_ranger = fit_ranger,
                          fit_Linda = fit_Linda,
                          fit_cforest= fit_cforest
                          ))                 
summary_resamps = as.data.frame(summary(resamps)$statistics)   

summary_resamps %>% t() %>% kable()   

#---------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------

# SELECT THE HIGHEST PERFORMANCE MODEL

# Save the model with the highest performance.

best_performing_model<-get(
  rownames(summary_resamps)[which(summary_resamps$F1.Max == max(summary_resamps$F1.Max))])

# Extract model name

best_performing_model_name<-best_performing_model$method  

# Print the name.

str_glue("The best model is {best_performing_model_name}")


#---------------------------------------------------------------------------------------------------------------
#---------------------------------------------------------------------------------------------------------------

# PREDICTOR EVALUATION. (From now on data_test is used)

# Predictions are calculated for all test set data in all models. It is defined Alive=1 and Dead=0

# CREATE THE getFinalPredictions FUNCTION.

getFinalPredictions = function(fit_lr, data_test, prob_threshold=0.5){                    # Change the fit to the best_model.
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr, newdata=data_test, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test$patientunitstayid,                
                                 trueStatus = data_test$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

#-------------------------------------------------------------------------------

# Use the getFinalPredictions function on the best model and all the others.

final_predictions = getFinalPredictions(best_performing_model, data_test)
final_predictions_gbm = getFinalPredictions(fit_gbm, data_test)
final_predictions_rf = getFinalPredictions(fit_rf, data_test)
final_predictions_xgb = getFinalPredictions(fit_xgb, data_test)
final_predictions_lr = getFinalPredictions(fit_lr, data_test)
final_predictions_lda = getFinalPredictions(fit_lda, data_test)
final_predictions_kernelpls = getFinalPredictions(fit_kernelpls, data_test)
final_predictions_ranger = getFinalPredictions(fit_ranger, data_test)
final_predictions_Linda = getFinalPredictions(fit_Linda, data_test)
final_predictions_cforest = getFinalPredictions(fit_cforest, data_test)

# Each model was evaluated manually to verify that the lr model is the one with the highest F1.

```


# CONFUSION MATRIX OF ALL MODELS

```{r}

# gbm CONFUSION MATRIX

# The dependent variable must be of type factor.

# icu_mortality_72hrs
final_predictions_gbm$obs <- as.factor(final_predictions_gbm$obs)

# mortality_prediction_B
final_predictions_gbm$pred <- as.factor(final_predictions_gbm$pred)

# confusion matrix

matrix_gbm <- confusionMatrix(final_predictions_gbm$pred, final_predictions_gbm$obs, mode = "everything")

#---

# rf CONFUSION MATRIX

# The dependent variable must be of type factor.

# icu_mortality_72hrs
final_predictions_rf$obs <- as.factor(final_predictions_rf$obs)

# mortality_prediction_B
final_predictions_rf$pred <- as.factor(final_predictions_rf$pred)

# confusion matrix

matrix_rf <- confusionMatrix(final_predictions_rf$pred, final_predictions_rf$obs, mode = "everything")

#---

# xgb CONFUSION MATRIX

# The dependent variable must be of type factor.

# icu_mortality_72hrs
final_predictions_xgb$obs <- as.factor(final_predictions_xgb$obs)

# mortality_prediction_B
final_predictions_xgb$pred <- as.factor(final_predictions_xgb$pred)

# confusion matrix

matrix_xgb <- confusionMatrix(final_predictions_xgb$pred, final_predictions_xgb$obs, mode = "everything")

#---

# lr CONFUSION MATRIX

# The dependent variable must be of type factor.

# icu_mortality_72hrs
final_predictions_lr$obs <- as.factor(final_predictions_lr$obs)

# mortality_prediction_B
final_predictions_lr$pred <- as.factor(final_predictions_lr$pred)

# confusion matrix

matrix_lr <- confusionMatrix(final_predictions_lr$pred, final_predictions_lr$obs, mode = "everything")

#---

# lda CONFUSION MATRIX

# The dependent variable must be of type factor.

# icu_mortality_72hrs
final_predictions_lda$obs <- as.factor(final_predictions_lda$obs)

# mortality_prediction_B
final_predictions_lda$pred <- as.factor(final_predictions_lda$pred)

# confusion matrix

matrix_lda <- confusionMatrix(final_predictions_lda$pred, final_predictions_lda$obs, mode = "everything")

#---

# kernelpls CONFUSION MATRIX

# The dependent variable must be of type factor.

# icu_mortality_72hrs
final_predictions_kernelpls$obs <- as.factor(final_predictions_kernelpls$obs)

# mortality_prediction_B
final_predictions_kernelpls$pred <- as.factor(final_predictions_kernelpls$pred)

# confusion matrix

matrix_kernelpls <- confusionMatrix(final_predictions_kernelpls$pred, final_predictions_kernelpls$obs, mode = "everything")

#---

# ranger CONFUSION MATRIX

# The dependent variable must be of type factor.

# icu_mortality_72hrs
final_predictions_ranger$obs <- as.factor(final_predictions_ranger$obs)

# mortality_prediction_B
final_predictions_ranger$pred <- as.factor(final_predictions_ranger$pred)

# confusion matrix

matrix_ranger <- confusionMatrix(final_predictions_ranger$pred, final_predictions_ranger$obs, mode = "everything")

#---

# Linda CONFUSION MATRIX

# The dependent variable must be of type factor.

# icu_mortality_72hrs
final_predictions_Linda$obs <- as.factor(final_predictions_Linda$obs)

# mortality_prediction_B
final_predictions_Linda$pred <- as.factor(final_predictions_Linda$pred)

# confusion matrix

matrix_Linda <- confusionMatrix(final_predictions_Linda$pred, final_predictions_Linda$obs, mode = "everything")

#---

# cforest CONFUSION MATRIX

# The dependent variable must be of type factor.

# icu_mortality_72hrs
final_predictions_cforest$obs <- as.factor(final_predictions_cforest$obs)

# mortality_prediction_B
final_predictions_cforest$pred <- as.factor(final_predictions_cforest$pred)

# confusion matrix

matrix_cforest <- confusionMatrix(final_predictions_cforest$pred, final_predictions_cforest$obs, mode = "everything")

```


# COMPARATIVE TABLE

```{r}

# PRECISION

gbm_Precision <- matrix_gbm$table[1, 1] / sum(matrix_gbm$table[1, ])
rf_Precision <- matrix_rf$table[1, 1] / sum(matrix_rf$table[1, ])
xgb_Precision <- matrix_xgb$table[1, 1] / sum(matrix_xgb$table[1, ])
lr_Precision <- matrix_lr$table[1, 1] / sum(matrix_lr$table[1, ])
lda_Precision <- matrix_lda$table[1, 1] / sum(matrix_lda$table[1, ])
kernelpls_Precision <- matrix_kernelpls$table[1, 1] / sum(matrix_kernelpls$table[1, ])
ranger_Precision <- matrix_ranger$table[1, 1] / sum(matrix_ranger$table[1, ])
Linda_Precision <- matrix_Linda$table[1, 1] / sum(matrix_Linda$table[1, ])
cforest_Precision <- matrix_cforest$table[1, 1] / sum(matrix_cforest$table[1, ])


# RECALL

gbm_recall <- matrix_gbm$table[1, 1] / sum(matrix_gbm$table[, 1])
rf_recall <- matrix_rf$table[1, 1] / sum(matrix_rf$table[, 1])
xgb_recall <- matrix_xgb$table[1, 1] / sum(matrix_xgb$table[, 1])
lr_recall <- matrix_lr$table[1, 1] / sum(matrix_lr$table[, 1])
lda_recall <- matrix_lda$table[1, 1] / sum(matrix_lda$table[, 1])
kernelpls_recall <- matrix_kernelpls$table[1, 1] / sum(matrix_kernelpls$table[, 1])
ranger_recall <- matrix_ranger$table[1, 1] / sum(matrix_ranger$table[, 1])
Linda_recall <- matrix_Linda$table[1, 1] / sum(matrix_Linda$table[, 1])
cforest_recall <- matrix_cforest$table[1, 1] / sum(matrix_cforest$table[, 1])


# PARAMETER F1.

gbm_F1 <-F1_Score(final_predictions_gbm$obs, final_predictions_gbm$recall)
rf_F1 <-F1_Score(final_predictions_rf$obs, final_predictions_rf$pred)
xgb_F1 <-F1_Score(final_predictions_xgb$obs, final_predictions_xgb$pred)
lr_F1 <-F1_Score(final_predictions_lr$obs, final_predictions_lr$pred)
lda_F1 <-F1_Score(final_predictions_lda$obs, final_predictions_lda$pred)
kernelpls_F1 <-F1_Score(final_predictions_kernelpls$obs, final_predictions_kernelpls$pred)
ranger_F1 <-F1_Score(final_predictions_ranger$obs, final_predictions_ranger$pred)
Linda_F1 <-F1_Score(final_predictions_Linda$obs, final_predictions_Linda$pred)
cforest_F1 <-F1_Score(final_predictions_cforest$obs, final_predictions_cforest$pred)

#-------------------------------------------------------------------------------

# CREATE THE TABLE

# Models
Models <- c("lr", "cforest", "lda", "kernelpls", "Linda", "gbm", "xgb", "ranger", "rf")

# Precision
Precision <- round(c(lr_Precision, cforest_Precision, lda_Precision, kernelpls_Precision, Linda_Precision, gbm_Precision, xgb_Precision, ranger_Precision, rf_Precision),3)

# Recall
Recall <- round(c(lr_recall, cforest_recall, lda_recall, kernelpls_recall, Linda_recall, gbm_recall, xgb_recall, ranger_recall, rf_recall),3)

# F1 score
F1 <- round(c(lr_F1, cforest_F1, lda_F1, kernelpls_F1, Linda_F1, gbm_F1, xgb_F1, ranger_F1, rf_F1),3)


# Dataframe
comparative_table <- data.frame(Models = Models, Precision = Precision, Recall = Recall, F1 = F1)

print(comparative_table)

```



# TRAINING ONLY THE SELECTED MODEL

The selected model is lr (LogitBoost).

```{r}

# Training and predictions ONLY of the created model

set.seed(123)

hora_inicio_seleccionado <- Sys.time() 

fit_lr <- train(outcome_and_exposure,          #F1:0,7536  Success:61,32%
                data = data_train_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

hora_fin_seleccionado <- Sys.time() 

#---

# SAVE THE MODEL

# You can save the model so you don't have to run it again.

saveRDS(fit_lr, file = "lr_model.Rda")

# UPLOAD THE MODEL

# If you have run model training previously you can load the saved model to save time.

fit_lr <- readRDS("lr_model.Rda")

#---

# CREATE THE getFinalPredictions FUNCTION.

getFinalPredictions = function(fit_lr, data_test, prob_threshold=0.5){                    # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr, newdata=data_test, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test$patientunitstayid,                
                                 trueStatus = data_test$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr = getFinalPredictions(fit_lr, data_test)
final_predictions <- final_predictions_lr

```


# CONFUSION MATRIX OF THE ALREADY CHOSEN MODEL

```{r}

#                     CONFUSION MATRIX

# The dependent variable must be of type factor.

# icu_mortality_72hrs
final_predictions$obs <- as.factor(final_predictions$obs)

levels(final_predictions$obs)

# mortality_prediction_B
final_predictions$pred <- as.factor(final_predictions$pred)

levels(final_predictions$pred)

# confusion matrix

confusionMatrix(final_predictions$pred, final_predictions$obs, mode = "everything")

```

# PRECISION-RECALL CURVE

```{r}

# Function to calculate precision and recall for different classification thresholds.
calculate_precision_recall <- function(predictions, true_labels) {
  df <- tibble(pred = predictions, true = true_labels)                   # 2 vectors: real observation and predictions.
  
  df <- df %>%                                      # Calculation of true positives (TP), false positives (FP) and false negatives (FN)
    mutate(TP = ifelse(pred == 1 & true == 1, 1, 0),
           FP = ifelse(pred == 1 & true == 0, 1, 0),
           FN = ifelse(pred == 0 & true == 1, 1, 0))
  
  precision <- cumsum(df$TP) / (cumsum(df$TP) + cumsum(df$FP))   # Cumulative precision and recall for each classification threshold
  recall <- cumsum(df$TP) / sum(df$true == 1)
  
  df <- tibble(threshold = predictions, precision = precision, recall = recall)   # 3 colums tibble
  
  return(df)
}



# Calculate precision and recall for different thresholds

precision_recall_df <- calculate_precision_recall(final_predictions_lr$pred, final_predictions_lr$obs)


# Precision versus recall graph

ggplot(precision_recall_df, aes(x = recall, y = precision)) +
  geom_line() +
  geom_point() +
  labs(x = "Recall", y = "Precision") +
  ggtitle("Precision vs. Recall Curve")

```



# EVALUATION: PERCENTAGE OF CORRECT PREDICTION AND F1

```{r}

# 1º. PERCENTAGE (%) OF SUCCESSFUL

success <- mean(final_predictions$obs == final_predictions$pred)*100

str_glue("The percentage of correct answers is {round(success, digits = 3)} %")

# CAUTION: in unbalanced data you can obtain a high percentage of success. With a model that does not predict well (many 1s and few 0s, predicts mostly 1s).


# 2º. PARAMETER F1.

lr_F1 <-F1_Score(final_predictions_lr$obs, final_predictions_lr$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1, digits = 3)}")

```


# CHECK THE IMPORTANCE OF THE MODEL VARIABLES.

A graphic representation is made of the importance of each variable in the model.

```{r message=FALSE, warning=FALSE}

# Calculate the relative importance of the model variables.

importance <- varImp(fit_lr)


# ggplot

ggplot(importance, aes(x = Overall, y = reorder(rownames(importance), Overall))) +
  geom_bar(stat = "identity", width = 0.5, fill = "blue") +
  labs(title = "IMPORTANCE OF THE MODEL VARIABLES",
       x = "Variables",
       y = "Relative importance (%)") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 7)) +
  coord_flip() 

```

# SUBGROUPS PREDICTIONS (FAIRNESS)

## Option A: We use de trained model to predict by subgroups. So, F1 is the same for each subgroup. 

```{r}

# Sex. Subgroup analysis: male and female

# SUBGROUP 1: Sex - male

# We add the predictions of the model and then filter by...

pred_male <- data_test %>%
  cbind(final_predictions) %>%
  filter(sex == 0)

# PERCENTAGE (%) OF SUCCESS

success_male <- mean(pred_male$obs == pred_male$pred)*100

str_glue("The percentage of correct answers only for males is {round(success_male, digits = 3)} %")

#---

# SUBGROUP 2: Sex - female

pred_female <- data_test %>%
  cbind(final_predictions) %>%
  filter(sex == 1)

# PERCENTAGE (%) OF SUCCESS

success_female <- mean(pred_female$obs == pred_female$pred)*100

str_glue("The percentage of correct answers only for females is {round(success_female, digits = 3)} %")


#-------------------------------------------------------------------------------

# Age. Subgroups analysis: childhood (0-9 years), adolescence (10-19 years), youth (20-24), adulthood (25-64), old age (+65 years)

# SUBGROUP 3: age - 0-9 years   # NO DATA (min age = 17 years old)

pred_childhood <- data_test %>%
  cbind(final_predictions) %>%
  filter(age < 10)

#---

# SUBGROUP 4: age - 10-19 years

pred_adolescence <- data_test %>%
  cbind(final_predictions) %>%
  filter(age > 9) %>%
  filter(age < 20)

# PERCENTAGE (%) OF SUCCESS

success_adolescense <- mean(pred_adolescence$obs == pred_adolescence$pred)*100

str_glue("The percentage of correct answers only for adolescense is {round(success_adolescense, digits = 3)} %")

#---

# SUBGROUP 5: age - 20-24 years

pred_youth <- data_test %>%
  cbind(final_predictions) %>%
  filter(age > 19) %>%
  filter(age < 25)

# PERCENTAGE (%) OF SUCCESS

success_youth <- mean(pred_youth$obs == pred_youth$pred)*100

str_glue("The percentage of correct answers only for youth is {round(success_youth, digits = 3)} %")

#---

# SUBGROUP 6: age - 25-64 years

pred_adulthood <- data_test %>%
  cbind(final_predictions) %>%
  filter(age > 24) %>%
  filter(age < 65)

# PERCENTAGE (%) OF SUCCESS

success_adulthood <- mean(pred_adulthood$obs == pred_adulthood$pred)*100

str_glue("The percentage of correct answers only for adulthood is {round(success_adulthood, digits = 3)} %")

#---

# SUBGROUP 6: age - >65 years

pred_old_age <- data_test %>%
  cbind(final_predictions) %>%
  filter(age > 64)

# PERCENTAGE (%) OF SUCCESS

success_old_age <- mean(pred_old_age$obs == pred_old_age$pred)*100

str_glue("The percentage of correct answers only for old age is {round(success_old_age, digits = 3)} %")

#-------------------------------------------------------------------------------

# Socioeconomic status (teaching status)

# We use the teaching status as a socioeconomic status index. # FALSE: 0   TRUE: 1. We consider that hospitals with teaching status have higher socioeconomic status.

# SUBGROUP 7: teachingstatus - 1 (TRUE)

pred_teach_true <- data_test %>%
  cbind(final_predictions) %>%
  filter(teachingstatus == 1)

# PERCENTAGE (%) OF SUCCESS

success_teach_true <- mean(pred_teach_true$obs == pred_teach_true$pred)*100

str_glue("The percentage of correct answers only for hospitals with teaching status true is {round(success_teach_true, digits = 3)} %")

#---

# SUBGROUP 8: teachingstatus - 0 (FALSE)

pred_teach_false <- data_test %>%
  cbind(final_predictions) %>%
  filter(teachingstatus == 0)

# PERCENTAGE (%) OF SUCCESS

success_teach_false <- mean(pred_teach_false$obs == pred_teach_false$pred)*100

str_glue("The percentage of correct answers only for hospitals with teaching status false is {round(success_teach_false, digits = 3)} %")

#---

# SUBGROUP 9: ethnicity - 0 (African American)

pred_african_american <- data_test %>%
  cbind(final_predictions) %>%
  filter(ethnicity == 0)

# PERCENTAGE (%) OF SUCCESS

success_african_american <- mean(pred_african_american$obs == pred_african_american$pred)*100

str_glue("The percentage of correct answers only for African American patients is {round(success_african_american, digits = 3)} %")

#---

# SUBGROUP 10: ethnicity - 1 (Asian)

pred_asian <- data_test %>%
  cbind(final_predictions) %>%
  filter(ethnicity == 1)

# PERCENTAGE (%) OF SUCCESS

success_asian <- mean(pred_asian$obs == pred_asian$pred)*100

str_glue("The percentage of correct answers only for asian patients is {round(success_asian, digits = 3)} %")

#---

# SUBGROUP 11: ethnicity - 2 (Caucasian)

pred_caucasian <- data_test %>%
  cbind(final_predictions) %>%
  filter(ethnicity == 2)

# PERCENTAGE (%) OF SUCCESS

success_caucasian <- mean(pred_caucasian$obs == pred_caucasian$pred)*100

str_glue("The percentage of correct answers only for caucasian patients is {round(success_caucasian, digits = 3)} %")

#---

# SUBGROUP 12: ethnicity - 3 (Hispanic)

pred_hispanic <- data_test %>%
  cbind(final_predictions) %>%
  filter(ethnicity == 3)

# PERCENTAGE (%) OF SUCCESS

success_hispanic <- mean(pred_hispanic$obs == pred_hispanic$pred)*100

str_glue("The percentage of correct answers only for hispanic patients is {round(success_hispanic, digits = 3)} %")

#---

# SUBGROUP 13: ethnicity - 4 (Native American)

pred_native_american <- data_test %>%
  cbind(final_predictions) %>%
  filter(ethnicity == 4)

# PERCENTAGE (%) OF SUCCESS

success_native_american <- mean(pred_native_american$obs == pred_native_american$pred)*100

str_glue("The percentage of correct answers only for native american patients is {round(success_native_american, digits = 3)} %")

#---

# SUBGROUP 14: ethnicity - 5 (Other/Unknown)

pred_ethnicity_other <- data_test %>%
  cbind(final_predictions) %>%
  filter(ethnicity == 5)

# PERCENTAGE (%) OF SUCCESS

success_ethnicity_other <- mean(pred_ethnicity_other$obs == pred_ethnicity_other$pred)*100

str_glue("The percentage of correct answers only for other ethnicity patients is {round(success_ethnicity_other, digits = 3)} %")

```
## Comparative table Option A

```{r}

# PERCENTAGE (%) OF SUCCESS

success_male <- mean(pred_male$obs == pred_male$pred)*100
success_female <- mean(pred_female$obs == pred_female$pred)*100
success_adolescense <- mean(pred_adolescence$obs == pred_adolescence$pred)*100
success_youth <- mean(pred_youth$obs == pred_youth$pred)*100
success_adulthood <- mean(pred_adulthood$obs == pred_adulthood$pred)*100
success_old_age <- mean(pred_old_age$obs == pred_old_age$pred)*100
success_teach_true <- mean(pred_teach_true$obs == pred_teach_true$pred)*100
success_teach_false <- mean(pred_teach_false$obs == pred_teach_false$pred)*100
success_african_american <- mean(pred_african_american$obs == pred_african_american$pred)*100
success_asian <- mean(pred_asian$obs == pred_asian$pred)*100
success_caucasian <- mean(pred_caucasian$obs == pred_caucasian$pred)*100
success_hispanic <- mean(pred_hispanic$obs == pred_hispanic$pred)*100
success_native_american <- mean(pred_native_american$obs == pred_native_american$pred)*100
success_ethnicity_other <- mean(pred_ethnicity_other$obs == pred_ethnicity_other$pred)*100

#-------------------------------------------------------------------------------

# In this case, F1 is the same for all subgroups.

# CREATE THE TABLE

# Models
Groups <- c("Male", "Female", "Adolescence", "Youth", "Adulthood", "Old Age", "Teach True", "Teach False", "African American", "Asian", "Caucasian", "Hispanic", "Native American", "Ethnicity Other")

# Success
success <- round(c(success_male, success_female, success_adolescense, success_youth, success_adulthood, success_old_age, success_teach_true, success_teach_false, success_african_american, success_asian, success_caucasian, success_hispanic, success_native_american, success_ethnicity_other),3)

# Dataframe
comparative_option_A <- data.frame(Groups = Groups, Success = paste0(success, "%"))

print(comparative_option_A)


```


## Option B: We filter raw data first, and then we train the model with this data (dividing in train and test).

SUBGROUP 1: Sex - male

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

final_df_male <- final_df_selected %>%
  filter(sex == 0)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_male$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_male = final_df_male[idx_train, ]
data_test_male  = final_df_male[-idx_train, ]

# 2º FORMULA

final_df_male_without_ID <- final_df_male %>%
  select(-patientunitstayid)

data_train_male_without_ID <- data_train_male %>%
  select(-patientunitstayid)

outcome_model_male <- "icu_mortality_72hrs"                                   
exposures_model_male <- names(data_train_male_without_ID)                   
exposures_model_male <- exposures_model_male[-which(exposures_model_male == outcome_model_male)]   

# Model formula

outcome_and_exposure_male <- as.formula(paste(outcome_model_male, "~", paste(exposures_model_male, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_male <- train(outcome_and_exposure_male,          #F1:0.3804   Success:31.126%
                data = data_train_male_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_male, file = "lr_male_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_male, data_test_male, prob_threshold=0.5){                 # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_male, newdata=data_test_male, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_male$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_male$patientunitstayid,                
                                 trueStatus = data_test_male$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_male = getFinalPredictions(fit_lr_male, data_test_male)
final_predictions_male <- final_predictions_lr_male


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_male$obs <- as.factor(final_predictions_male$obs)

levels(final_predictions_male$obs)

# mortality_prediction_B
final_predictions_male$pred <- as.factor(final_predictions_male$pred)

levels(final_predictions_male$pred)

# confusion matrix

matrix_1 <- confusionMatrix(final_predictions_male$pred, final_predictions_male$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_male <- mean(final_predictions_male$obs == final_predictions_male$pred)*100

str_glue("The percentage of correct answers is {round(success_male, digits = 3)} %")


lr_F1_male <-F1_Score(final_predictions_lr_male$obs, final_predictions_lr_male$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_male, digits = 3)}")



# PRECISION

m1_Precision <- matrix_1$table[1, 1] / sum(matrix_1$table[1, ])

# RECALL

m1_recall <- matrix_1$table[1, 1] / sum(matrix_1$table[, 1])

```


SUBGROUP 2: Sex - female

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

final_df_female <- final_df_selected %>%
  filter(sex == 1)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_female$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_female = final_df_female[idx_train, ]
data_test_female  = final_df_female[-idx_train, ]

# 2º FORMULA

final_df_female_without_ID <- final_df_female %>%
  select(-patientunitstayid)

data_train_female_without_ID <- data_train_female %>%
  select(-patientunitstayid)

outcome_model_female <- "icu_mortality_72hrs"                                   
exposures_model_female <- names(data_train_female_without_ID)                   
exposures_model_female <- exposures_model_female[-which(exposures_model_female == outcome_model_female)]   

# Model formula

outcome_and_exposure_female <- as.formula(paste(outcome_model_female, "~", paste(exposures_model_female, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_female <- train(outcome_and_exposure_female,          #F1:0,5955  Success:45,721%
                data = data_train_female_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_female, file = "lr_female_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_female, data_test_female, prob_threshold=0.5){                 # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_female, newdata=data_test_female, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_female$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_female$patientunitstayid,                
                                 trueStatus = data_test_female$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_female = getFinalPredictions(fit_lr_female, data_test_female)
final_predictions_female <- final_predictions_lr_female


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_female$obs <- as.factor(final_predictions_female$obs)

levels(final_predictions_female$obs)

# mortality_prediction_B
final_predictions_female$pred <- as.factor(final_predictions_female$pred)

levels(final_predictions_female$pred)

# confusion matrix

matrix_2 <- confusionMatrix(final_predictions_female$pred, final_predictions_female$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_female <- mean(final_predictions_female$obs == final_predictions_female$pred)*100

str_glue("The percentage of correct answers is {round(success_female, digits = 3)} %")


lr_F1_female <-F1_Score(final_predictions_lr_female$obs, final_predictions_lr_female$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_female, digits = 3)}")



# PRECISION

m2_Precision <- matrix_2$table[1, 1] / sum(matrix_2$table[1, ])

# RECALL

m2_recall <- matrix_2$table[1, 1] / sum(matrix_2$table[, 1])

```


SUBGROUP 3: age - 0-9 years   # NO DATA (min age = 17 years old)

SUBGROUP 4: age - 10-19 years

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

final_df_adolescence <- final_df_selected %>%
  filter(age > 9) %>%
  filter(age < 20)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_adolescence$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_adolescence = final_df_adolescence[idx_train, ]
data_test_adolescence  = final_df_adolescence[-idx_train, ]

# 2º FORMULA

final_df_adolescence_without_ID <- final_df_adolescence %>%
  select(-patientunitstayid)

data_train_adolescence_without_ID <- data_train_adolescence %>%
  select(-patientunitstayid)

outcome_model_adolescence <- "icu_mortality_72hrs"                                   
exposures_model_adolescence <- names(data_train_adolescence_without_ID)                   
exposures_model_adolescence <- exposures_model_adolescence[-which(exposures_model_adolescence == outcome_model_adolescence)]   

# Model formula

outcome_and_exposure_adolescence <- as.formula(paste(outcome_model_adolescence, "~", paste(exposures_model_adolescence, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_adolescence <- train(outcome_and_exposure_adolescence,          #F1:0,6370  Success:50,6712%
                data = data_train_adolescence_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_adolescence, file = "lr_adolescence_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_adolescence, data_test_adolescence, prob_threshold=0.5){       # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_adolescence, newdata=data_test_adolescence, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_adolescence$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_adolescence$patientunitstayid,                
                                 trueStatus = data_test_adolescence$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_adolescence = getFinalPredictions(fit_lr_adolescence, data_test_adolescence)
final_predictions_adolescence <- final_predictions_lr_adolescence


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_adolescence$obs <- as.factor(final_predictions_adolescence$obs)

levels(final_predictions_adolescence$obs)

# mortality_prediction_B
final_predictions_adolescence$pred <- as.factor(final_predictions_adolescence$pred)

levels(final_predictions_adolescence$pred)

# confusion matrix

matrix_4 <- confusionMatrix(final_predictions_adolescence$pred, final_predictions_adolescence$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_adolescence <- mean(final_predictions_adolescence$obs == final_predictions_adolescence$pred)*100

str_glue("The percentage of correct answers is {round(success_adolescence, digits = 3)} %")


lr_F1_adolescence <-F1_Score(final_predictions_lr_adolescence$obs, final_predictions_lr_adolescence$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_adolescence, digits = 3)}")



# PRECISION

m4_Precision <- matrix_4$table[1, 1] / sum(matrix_4$table[1, ])

# RECALL

m4_recall <- matrix_4$table[1, 1] / sum(matrix_4$table[, 1])

```


SUBGROUP 5: age - 20-24 years

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 5: age - 20-24 years

final_df_youth <- final_df_selected %>%
  filter(age > 19) %>%
  filter(age < 25)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_youth$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_youth = final_df_youth[idx_train, ]
data_test_youth  = final_df_youth[-idx_train, ]

# 2º FORMULA

final_df_youth_without_ID <- final_df_youth %>%
  select(-patientunitstayid)

data_train_youth_without_ID <- data_train_youth %>%
  select(-patientunitstayid)

outcome_model_youth <- "icu_mortality_72hrs"                                   
exposures_model_youth <- names(data_train_youth_without_ID)                   
exposures_model_youth <- exposures_model_youth[-which(exposures_model_youth == outcome_model_youth)]   

# Model formula

outcome_and_exposure_youth <- as.formula(paste(outcome_model_youth, "~", paste(exposures_model_youth, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_youth <- train(outcome_and_exposure_youth,          #F1:0,72372  Success:57,836%
                data = data_train_youth_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_youth, file = "lr_youth_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_youth, data_test_youth, prob_threshold=0.5){                 # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_youth, newdata=data_test_youth, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_youth$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_youth$patientunitstayid,                
                                 trueStatus = data_test_youth$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_youth = getFinalPredictions(fit_lr_youth, data_test_youth)
final_predictions_youth <- final_predictions_lr_youth


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_youth$obs <- as.factor(final_predictions_youth$obs)

levels(final_predictions_youth$obs)

# mortality_prediction_B
final_predictions_youth$pred <- as.factor(final_predictions_youth$pred)

levels(final_predictions_youth$pred)

# confusion matrix

matrix_5 <- confusionMatrix(final_predictions_youth$pred, final_predictions_youth$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_youth <- mean(final_predictions_youth$obs == final_predictions_youth$pred)*100

str_glue("The percentage of correct answers is {round(success_youth, digits = 3)} %")


lr_F1_youth <-F1_Score(final_predictions_lr_youth$obs, final_predictions_lr_youth$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_youth, digits = 3)}")



# PRECISION

m5_Precision <- matrix_5$table[1, 1] / sum(matrix_5$table[1, ])

# RECALL

m5_recall <- matrix_5$table[1, 1] / sum(matrix_5$table[, 1])

```


SUBGROUP 6: age - 25-64 years

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 6: age - 25-64 years

final_df_adulthood <- final_df_selected %>%
  filter(age > 24) %>%
  filter(age < 65)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_adulthood$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_adulthood = final_df_adulthood[idx_train, ]
data_test_adulthood  = final_df_adulthood[-idx_train, ]

# 2º FORMULA

final_df_adulthood_without_ID <- final_df_adulthood %>%
  select(-patientunitstayid)

data_train_adulthood_without_ID <- data_train_adulthood %>%
  select(-patientunitstayid)

outcome_model_adulthood <- "icu_mortality_72hrs"                                   
exposures_model_adulthood <- names(data_train_adulthood_without_ID)                   
exposures_model_adulthood <- exposures_model_adulthood[-which(exposures_model_adulthood == outcome_model_adulthood)]   

# Model formula

outcome_and_exposure_adulthood <- as.formula(paste(outcome_model_adulthood, "~", paste(exposures_model_adulthood, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_adulthood <- train(outcome_and_exposure_adulthood,          #F1:0,72372  Success:57,836%
                data = data_train_adulthood_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_adulthood, file = "lr_adulthood_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_adulthood, data_test_adulthood, prob_threshold=0.5){                 # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_adulthood, newdata=data_test_adulthood, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_adulthood$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_adulthood$patientunitstayid,                
                                 trueStatus = data_test_adulthood$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_adulthood = getFinalPredictions(fit_lr_adulthood, data_test_adulthood)
final_predictions_adulthood <- final_predictions_lr_adulthood


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_adulthood$obs <- as.factor(final_predictions_adulthood$obs)

levels(final_predictions_adulthood$obs)

# mortality_prediction_B
final_predictions_adulthood$pred <- as.factor(final_predictions_adulthood$pred)

levels(final_predictions_adulthood$pred)

# confusion matrix

matrix_6 <- confusionMatrix(final_predictions_adulthood$pred, final_predictions_adulthood$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_adulthood <- mean(final_predictions_adulthood$obs == final_predictions_adulthood$pred)*100

str_glue("The percentage of correct answers is {round(success_adulthood, digits = 3)} %")


lr_F1_adulthood<-F1_Score(final_predictions_lr_adulthood$obs, final_predictions_lr_adulthood$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_adulthood, digits = 3)}")



# PRECISION

m6_Precision <- matrix_6$table[1, 1] / sum(matrix_6$table[1, ])

# RECALL

m6_recall <- matrix_6$table[1, 1] / sum(matrix_6$table[, 1])

```


SUBGROUP 7: age - >65 years

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 7: age - >65 years

final_df_old_age <- final_df_selected %>%
  filter(age > 64)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_old_age$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_old_age = final_df_old_age[idx_train, ]
data_test_old_age  = final_df_old_age[-idx_train, ]

# 2º FORMULA

final_df_old_age_without_ID <- final_df_old_age %>%
  select(-patientunitstayid)

data_train_old_age_without_ID <- data_train_old_age %>%
  select(-patientunitstayid)

outcome_model_old_age <- "icu_mortality_72hrs"                                   
exposures_model_old_age <- names(data_train_old_age_without_ID)                   
exposures_model_old_age <- exposures_model_old_age[-which(exposures_model_old_age == outcome_model_old_age)]   

# Model formula

outcome_and_exposure_old_age <- as.formula(paste(outcome_model_old_age, "~", paste(exposures_model_old_age, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_old_age <- train(outcome_and_exposure_old_age,          #F1:0,3915  Success:31,126%
                data = data_train_old_age_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_old_age, file = "lr_old_age_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_old_age, data_test_old_age, prob_threshold=0.5){                 # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_old_age, newdata=data_test_old_age, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_old_age$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_old_age$patientunitstayid,                
                                 trueStatus = data_test_old_age$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_old_age = getFinalPredictions(fit_lr_old_age, data_test_old_age)
final_predictions_old_age <- final_predictions_lr_old_age


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_old_age$obs <- as.factor(final_predictions_old_age$obs)

levels(final_predictions_old_age$obs)

# mortality_prediction_B
final_predictions_old_age$pred <- as.factor(final_predictions_old_age$pred)

levels(final_predictions_old_age$pred)

# confusion matrix

matrix_7 <- confusionMatrix(final_predictions_old_age$pred, final_predictions_old_age$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_old_age <- mean(final_predictions_old_age$obs == final_predictions_old_age$pred)*100

str_glue("The percentage of correct answers is {round(success_old_age, digits = 3)} %")


lr_F1_old_age <-F1_Score(final_predictions_lr_old_age$obs, final_predictions_lr_old_age$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_old_age, digits = 3)}")



# PRECISION

m7_Precision <- matrix_7$table[1, 1] / sum(matrix_7$table[1, ])

# RECALL

m7_recall <- matrix_7$table[1, 1] / sum(matrix_7$table[, 1])

```


SUBGROUP 8: teachingstatus - 1 (TRUE)

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 8: teachingstatus - 1 (TRUE)

final_df_teach_true <- final_df_selected %>%
  filter(teachingstatus == 1)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_teach_true$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_teach_true = final_df_teach_true[idx_train, ]
data_test_teach_true  = final_df_teach_true[-idx_train, ]

# 2º FORMULA

final_df_teach_true_without_ID <- final_df_teach_true %>%
  select(-patientunitstayid)

data_train_teach_true_without_ID <- data_train_teach_true %>%
  select(-patientunitstayid)

outcome_model_teach_true <- "icu_mortality_72hrs"                                   
exposures_model_teach_true <- names(data_train_teach_true_without_ID)                   
exposures_model_teach_true <- exposures_model_teach_true[-which(exposures_model_teach_true == outcome_model_teach_true)]   

# Model formula

outcome_and_exposure_teach_true <- as.formula(paste(outcome_model_teach_true, "~", paste(exposures_model_teach_true, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_teach_true <- train(outcome_and_exposure_teach_true,          #F1:0,5316   Success:38,679%
                data = data_train_teach_true_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_teach_true, file = "lr_teach_true_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_teach_true, data_test_teach_true, prob_threshold=0.5){       # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_teach_true, newdata=data_test_teach_true, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_teach_true$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_teach_true$patientunitstayid,                
                                 trueStatus = data_test_teach_true$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_teach_true = getFinalPredictions(fit_lr_teach_true, data_test_teach_true)
final_predictions_teach_true <- final_predictions_lr_teach_true


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_teach_true$obs <- as.factor(final_predictions_teach_true$obs)

levels(final_predictions_teach_true$obs)

# mortality_prediction_B
final_predictions_teach_true$pred <- as.factor(final_predictions_teach_true$pred)

levels(final_predictions_teach_true$pred)

# confusion matrix

matrix_8 <- confusionMatrix(final_predictions_teach_true$pred, final_predictions_teach_true$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_teach_true <- mean(final_predictions_teach_true$obs == final_predictions_teach_true$pred)*100

str_glue("The percentage of correct answers is {round(success_teach_true, digits = 3)} %")


lr_F1_teach_true <-F1_Score(final_predictions_lr_teach_true$obs, final_predictions_lr_teach_true$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_teach_true, digits = 3)}")



# PRECISION

m8_Precision <- matrix_8$table[1, 1] / sum(matrix_8$table[1, ])

# RECALL

m8_recall <- matrix_8$table[1, 1] / sum(matrix_8$table[, 1])

```


SUBGROUP 9: teachingstatus - 0 (FALSE)

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 9: teachingstatus - 0 (FALSE)

final_df_teach_false <- final_df_selected %>%
  filter(teachingstatus == 0)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_teach_false$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_teach_false = final_df_teach_false[idx_train, ]
data_test_teach_false  = final_df_teach_false[-idx_train, ]

# 2º FORMULA

final_df_teach_false_without_ID <- final_df_teach_false %>%
  select(-patientunitstayid)

data_train_teach_false_without_ID <- data_train_teach_false %>%
  select(-patientunitstayid)

outcome_model_teach_false <- "icu_mortality_72hrs"                                   
exposures_model_teach_false <- names(data_train_teach_false_without_ID)                   
exposures_model_teach_false <- exposures_model_teach_false[-which(exposures_model_teach_false == outcome_model_teach_false)]   

# Model formula

outcome_and_exposure_teach_false <- as.formula(paste(outcome_model_teach_false, "~", paste(exposures_model_teach_false, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_teach_false <- train(outcome_and_exposure_teach_false,          #F1:0,7348   Success:59,504%
                data = data_train_teach_false_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_teach_false, file = "lr_teach_false_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_teach_false, data_test_teach_false, prob_threshold=0.5){       # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_teach_false, newdata=data_test_teach_false, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_teach_false$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_teach_false$patientunitstayid,                
                                 trueStatus = data_test_teach_false$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_teach_false = getFinalPredictions(fit_lr_teach_false, data_test_teach_false)
final_predictions_teach_false <- final_predictions_lr_teach_false


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_teach_false$obs <- as.factor(final_predictions_teach_false$obs)

levels(final_predictions_teach_false$obs)

# mortality_prediction_B
final_predictions_teach_false$pred <- as.factor(final_predictions_teach_false$pred)

levels(final_predictions_teach_false$pred)

# confusion matrix

matrix_9 <- confusionMatrix(final_predictions_teach_false$pred, final_predictions_teach_false$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_teach_false <- mean(final_predictions_teach_false$obs == final_predictions_teach_false$pred)*100

str_glue("The percentage of correct answers is {round(success_teach_false, digits = 3)} %")


lr_F1_teach_false <-F1_Score(final_predictions_lr_teach_false$obs, final_predictions_lr_teach_false$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_teach_false, digits = 3)}")



# PRECISION

m9_Precision <- matrix_9$table[1, 1] / sum(matrix_9$table[1, ])

# RECALL

m9_recall <- matrix_9$table[1, 1] / sum(matrix_9$table[, 1])

```


SUBGROUP 10: ethnicity - 0 (African American)

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 10: ethnicity - 0 (African American)

final_df_african_american <- final_df_selected %>%
  filter(ethnicity == 0)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_african_american$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_african_american = final_df_african_american[idx_train, ]
data_test_african_american  = final_df_african_american[-idx_train, ]

# 2º FORMULA

final_df_african_american_without_ID <- final_df_african_american %>%
  select(-patientunitstayid)

data_train_african_american_without_ID <- data_train_african_american %>%
  select(-patientunitstayid)

outcome_model_african_american <- "icu_mortality_72hrs"                                   
exposures_model_african_american <- names(data_train_african_american_without_ID)                   
exposures_model_african_american <- exposures_model_african_american[-which(exposures_model_african_american == outcome_model_african_american)]   

# Model formula

outcome_and_exposure_african_american <- as.formula(paste(outcome_model_african_american, "~", paste(exposures_model_african_american, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_african_american <- train(outcome_and_exposure_african_american,          #F1:0,6933   Success:54,503%
                data = data_train_african_american_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_african_american, file = "lr_african_american_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_african_american, data_test_african_american, prob_threshold=0.5){       # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_african_american, newdata=data_test_african_american, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_african_american$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_african_american$patientunitstayid,                
                                 trueStatus = data_test_african_american$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_african_american = getFinalPredictions(fit_lr_african_american, data_test_african_american)
final_predictions_african_american <- final_predictions_lr_african_american


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_african_american$obs <- as.factor(final_predictions_african_american$obs)

levels(final_predictions_african_american$obs)

# mortality_prediction_B
final_predictions_african_american$pred <- as.factor(final_predictions_african_american$pred)

levels(final_predictions_african_american$pred)

# confusion matrix

matrix_10 <- confusionMatrix(final_predictions_african_american$pred, final_predictions_african_american$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_african_american <- mean(final_predictions_african_american$obs == final_predictions_african_american$pred)*100

str_glue("The percentage of correct answers is {round(success_african_american, digits = 3)} %")


lr_F1_african_american <-F1_Score(final_predictions_lr_african_american$obs, final_predictions_lr_african_american$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_african_american, digits = 3)}")



# PRECISION

m10_Precision <- matrix_10$table[1, 1] / sum(matrix_10$table[1, ])

# RECALL

m10_recall <- matrix_10$table[1, 1] / sum(matrix_10$table[, 1])

```


SUBGROUP 11: ethnicity - 1 (Asian)

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 11: ethnicity - 1 (Asian)

final_df_asian <- final_df_selected %>%
  filter(ethnicity == 1)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_asian$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_asian = final_df_asian[idx_train, ]
data_test_asian  = final_df_asian[-idx_train, ]

# 2º FORMULA

final_df_asian_without_ID <- final_df_asian %>%
  select(-patientunitstayid)

data_train_asian_without_ID <- data_train_asian %>%
  select(-patientunitstayid)

outcome_model_asian <- "icu_mortality_72hrs"                                   
exposures_model_asian <- names(data_train_asian_without_ID)                   
exposures_model_asian <- exposures_model_asian[-which(exposures_model_asian == outcome_model_asian)]   

# Model formula

outcome_and_exposure_asian <- as.formula(paste(outcome_model_asian, "~", paste(exposures_model_asian, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_asian <- train(outcome_and_exposure_asian,          #F1:0,5807    Success:44,717%
                data = data_train_asian_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_asian, file = "lr_asian_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_asian, data_test_asian, prob_threshold=0.5){       # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_asian, newdata=data_test_asian, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_asian$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_asian$patientunitstayid,                
                                 trueStatus = data_test_asian$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_asian = getFinalPredictions(fit_lr_asian, data_test_asian)
final_predictions_asian <- final_predictions_lr_asian


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_asian$obs <- as.factor(final_predictions_asian$obs)

levels(final_predictions_asian$obs)

# mortality_prediction_B
final_predictions_asian$pred <- as.factor(final_predictions_asian$pred)

levels(final_predictions_asian$pred)

# confusion matrix

matrix_11 <- confusionMatrix(final_predictions_asian$pred, final_predictions_asian$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_asian <- mean(final_predictions_asian$obs == final_predictions_asian$pred)*100

str_glue("The percentage of correct answers is {round(success_asian, digits = 3)} %")


lr_F1_asian <-F1_Score(final_predictions_lr_asian$obs, final_predictions_lr_asian$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_asian, digits = 3)}")



# PRECISION

m11_Precision <- matrix_11$table[1, 1] / sum(matrix_11$table[1, ])

# RECALL

m11_recall <- matrix_11$table[1, 1] / sum(matrix_11$table[, 1])

```


SUBGROUP 12: ethnicity - 2 (Caucasian)

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 12: ethnicity - 2 (Caucasian)

final_df_caucasian <- final_df_selected %>%
  filter(ethnicity == 2)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_caucasian$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_caucasian = final_df_caucasian[idx_train, ]
data_test_caucasian  = final_df_caucasian[-idx_train, ]

# 2º FORMULA

final_df_caucasian_without_ID <- final_df_caucasian %>%
  select(-patientunitstayid)

data_train_caucasian_without_ID <- data_train_caucasian %>%
  select(-patientunitstayid)

outcome_model_caucasian <- "icu_mortality_72hrs"                                   
exposures_model_caucasian <- names(data_train_caucasian_without_ID)                   
exposures_model_caucasian <- exposures_model_caucasian[-which(exposures_model_caucasian == outcome_model_caucasian)]   

# Model formula

outcome_and_exposure_caucasian <- as.formula(paste(outcome_model_caucasian, "~", paste(exposures_model_caucasian, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_caucasian <- train(outcome_and_exposure_caucasian,          #F1:0,6941   Success:54,65%
                data = data_train_caucasian_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_caucasian, file = "lr_caucasian_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_caucasian, data_test_caucasian, prob_threshold=0.5){       # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_caucasian, newdata=data_test_caucasian, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_caucasian$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_caucasian$patientunitstayid,                
                                 trueStatus = data_test_caucasian$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_caucasian = getFinalPredictions(fit_lr_caucasian, data_test_caucasian)
final_predictions_caucasian <- final_predictions_lr_caucasian


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_caucasian$obs <- as.factor(final_predictions_caucasian$obs)

levels(final_predictions_caucasian$obs)

# mortality_prediction_B
final_predictions_caucasian$pred <- as.factor(final_predictions_caucasian$pred)

levels(final_predictions_caucasian$pred)

# confusion matrix

matrix_12 <- confusionMatrix(final_predictions_caucasian$pred, final_predictions_caucasian$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_caucasian <- mean(final_predictions_caucasian$obs == final_predictions_caucasian$pred)*100

str_glue("The percentage of correct answers is {round(success_caucasian, digits = 3)} %")


lr_F1_caucasian <-F1_Score(final_predictions_lr_caucasian$obs, final_predictions_lr_caucasian$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_caucasian, digits = 3)}")



# PRECISION

m12_Precision <- matrix_12$table[1, 1] / sum(matrix_12$table[1, ])

# RECALL

m12_recall <- matrix_12$table[1, 1] / sum(matrix_12$table[, 1])

```


SUBGROUP 13: ethnicity - 3 (Hispanic)

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 13: ethnicity - 3 (Hispanic)

final_df_hispanic <- final_df_selected %>%
  filter(ethnicity == 3)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_hispanic$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_hispanic = final_df_hispanic[idx_train, ]
data_test_hispanic  = final_df_hispanic[-idx_train, ]

# 2º FORMULA

final_df_hispanic_without_ID <- final_df_hispanic %>%
  select(-patientunitstayid)

data_train_hispanic_without_ID <- data_train_hispanic %>%
  select(-patientunitstayid)

outcome_model_hispanic <- "icu_mortality_72hrs"                                   
exposures_model_hispanic <- names(data_train_hispanic_without_ID)                   
exposures_model_hispanic <- exposures_model_hispanic[-which(exposures_model_hispanic == outcome_model_hispanic)]   

# Model formula

outcome_and_exposure_hispanic <- as.formula(paste(outcome_model_hispanic, "~", paste(exposures_model_hispanic, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_hispanic <- train(outcome_and_exposure_hispanic,          #F1:0,6503   Success:50,202%
                data = data_train_hispanic_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_hispanic, file = "lr_hispanic_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_hispanic, data_test_hispanic, prob_threshold=0.5){       # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_hispanic, newdata=data_test_hispanic, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_hispanic$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_hispanic$patientunitstayid,                
                                 trueStatus = data_test_hispanic$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_hispanic = getFinalPredictions(fit_lr_hispanic, data_test_hispanic)
final_predictions_hispanic <- final_predictions_lr_hispanic


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_hispanic$obs <- as.factor(final_predictions_hispanic$obs)

levels(final_predictions_hispanic$obs)

# mortality_prediction_B
final_predictions_hispanic$pred <- as.factor(final_predictions_hispanic$pred)

levels(final_predictions_hispanic$pred)

# confusion matrix

matrix_13 <- confusionMatrix(final_predictions_hispanic$pred, final_predictions_hispanic$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_hispanic <- mean(final_predictions_hispanic$obs == final_predictions_hispanic$pred)*100

str_glue("The percentage of correct answers is {round(success_hispanic, digits = 3)} %")


lr_F1_hispanic <-F1_Score(final_predictions_lr_hispanic$obs, final_predictions_lr_hispanic$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_hispanic, digits = 3)}")



# PRECISION

m13_Precision <- matrix_13$table[1, 1] / sum(matrix_13$table[1, ])

# RECALL

m13_recall <- matrix_13$table[1, 1] / sum(matrix_13$table[, 1])

```


SUBGROUP 14: ethnicity - 4 (Native American)

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 14: ethnicity - 4 (Native American)

final_df_native_american <- final_df_selected %>%
  filter(ethnicity == 4)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_native_american$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_native_american = final_df_native_american[idx_train, ]
data_test_native_american  = final_df_native_american[-idx_train, ]

# 2º FORMULA

final_df_native_american_without_ID <- final_df_native_american %>%
  select(-patientunitstayid)

data_train_native_american_without_ID <- data_train_native_american %>%
  select(-patientunitstayid)

outcome_model_native_american <- "icu_mortality_72hrs"                                   
exposures_model_native_american <- names(data_train_native_american_without_ID)                   
exposures_model_native_american <- exposures_model_native_american[-which(exposures_model_native_american == outcome_model_native_american)]   

# Model formula

outcome_and_exposure_native_american <- as.formula(paste(outcome_model_native_american, "~", paste(exposures_model_native_american, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_native_american <- train(outcome_and_exposure_native_american,          #F1:0,4293   Success:30,973%
                data = data_train_native_american_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_native_american, file = "lr_native_american_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_native_american, data_test_native_american, prob_threshold=0.5){       # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_native_american, newdata=data_test_native_american, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_native_american$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_native_american$patientunitstayid,                
                                 trueStatus = data_test_native_american$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_native_american = getFinalPredictions(fit_lr_native_american, data_test_native_american)
final_predictions_native_american <- final_predictions_lr_native_american


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_native_american$obs <- as.factor(final_predictions_native_american$obs)

levels(final_predictions_native_american$obs)

# mortality_prediction_B
final_predictions_native_american$pred <- as.factor(final_predictions_native_american$pred)

levels(final_predictions_native_american$pred)

# confusion matrix

matrix_14 <- confusionMatrix(final_predictions_native_american$pred, final_predictions_native_american$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_native_american <- mean(final_predictions_native_american$obs == final_predictions_native_american$pred)*100

str_glue("The percentage of correct answers is {round(success_native_american, digits = 3)} %")


lr_F1_native_american <-F1_Score(final_predictions_lr_native_american$obs, final_predictions_lr_native_american$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_native_american, digits = 3)}")



# PRECISION

m14_Precision <- matrix_14$table[1, 1] / sum(matrix_14$table[1, ])

# RECALL

m14_recall <- matrix_14$table[1, 1] / sum(matrix_14$table[, 1])

```


SUBGROUP 15: ethnicity - 5 (Other/Unknown)

```{r}

# Set the seed to make our partition reproducible.
set.seed(123)

#-------------------------------------------------------------------------------

# SUBGROUP 15: ethnicity - 5 (Other/Unknown)

final_df_ethnicity_other <- final_df_selected %>%
  filter(ethnicity == 5)

# 1. TRAIN-TEST SELECTION

# Select the target column.
idx_train  = createDataPartition(as.factor(final_df_ethnicity_other$icu_mortality_72hrs), times = 1, p = 0.80, list=F)[,1]

# Division into train and test
data_train_ethnicity_other = final_df_ethnicity_other[idx_train, ]
data_test_ethnicity_other  = final_df_ethnicity_other[-idx_train, ]

# 2º FORMULA

final_df_ethnicity_other_without_ID <- final_df_ethnicity_other %>%
  select(-patientunitstayid)

data_train_ethnicity_other_without_ID <- data_train_ethnicity_other %>%
  select(-patientunitstayid)

outcome_model_ethnicity_other <- "icu_mortality_72hrs"                                   
exposures_model_ethnicity_other <- names(data_train_ethnicity_other_without_ID)                   
exposures_model_ethnicity_other <- exposures_model_ethnicity_other[-which(exposures_model_ethnicity_other == outcome_model_ethnicity_other)]   

# Model formula

outcome_and_exposure_ethnicity_other <- as.formula(paste(outcome_model_ethnicity_other, "~", paste(exposures_model_ethnicity_other, collapse = " + "))) 

# 3. TRAINING THE MODEL

fit_lr_ethnicity_other <- train(outcome_and_exposure_ethnicity_other,          #F1:0,6532    Success:51,267%
                data = data_train_ethnicity_other_without_ID %>% as.data.frame(),
                method = "LogitBoost",
                trControl = fitControl,
                verbose = F,
                na.action = na.omit,
                metric = "F1")

saveRDS(fit_lr_ethnicity_other, file = "lr_ethnicity_other_model.Rda")

# 4. FINAL PREDICTIONS

getFinalPredictions = function(fit_lr_ethnicity_other, data_test_ethnicity_other, prob_threshold=0.5){       # Change the fit to the best_model. 
                                                                                           
  prediction_probabilities_tmp = predict(fit_lr_ethnicity_other, newdata=data_test_ethnicity_other, type = "prob")        

  rownames(prediction_probabilities_tmp) = data_test_ethnicity_other$patientunitstayid          

  # Match the prediction with current data.
  
  final_predictions_tmp = tibble(ID         = data_test_ethnicity_other$patientunitstayid,                
                                 trueStatus = data_test_ethnicity_other$icu_mortality_72hrs,               # Change target variable
                                 obs        = if_else(trueStatus == "Expired",1,0))        # If Expired, enter 1.

  final_predictions_tmp = cbind(final_predictions_tmp,                                    
                                prediction_probabilities_tmp[match(final_predictions_tmp$ID,    # Match using ID.
                                                                   rownames(prediction_probabilities_tmp)),])
  
  final_predictions_tmp %<>%
    dplyr::mutate(pred=dplyr::if_else(Alive > prob_threshold, 1, 0))
  
  final_predictions_tmp
}

# End of function

final_predictions_lr_ethnicity_other = getFinalPredictions(fit_lr_ethnicity_other, data_test_ethnicity_other)
final_predictions_ethnicity_other <- final_predictions_lr_ethnicity_other


# 5. CONFUSION MATRIX


# icu_mortality_72hrs
final_predictions_ethnicity_other$obs <- as.factor(final_predictions_ethnicity_other$obs)

levels(final_predictions_ethnicity_other$obs)

# mortality_prediction_B
final_predictions_ethnicity_other$pred <- as.factor(final_predictions_ethnicity_other$pred)

levels(final_predictions_ethnicity_other$pred)

# confusion matrix

matrix_15 <- confusionMatrix(final_predictions_ethnicity_other$pred, final_predictions_ethnicity_other$obs, mode = "everything")


# 6. PERCENTAGE (%) OF SUCCESSFUL

success_ethnicity_other <- mean(final_predictions_ethnicity_other$obs == final_predictions_ethnicity_other$pred)*100

str_glue("The percentage of correct answers is {round(success_ethnicity_other, digits = 3)} %")


lr_F1_ethnicity_other <-F1_Score(final_predictions_lr_ethnicity_other$obs, final_predictions_lr_ethnicity_other$pred)

# PRINT

str_glue("lr model F1 is {round(lr_F1_ethnicity_other, digits = 3)}")



# PRECISION

m15_Precision <- matrix_15$table[1, 1] / sum(matrix_15$table[1, ])

# RECALL

m15_recall <- matrix_15$table[1, 1] / sum(matrix_15$table[, 1])

```



## Resumen de resultados

```{r}

# SUBGROUP 1: Sex - male
str_glue("The percentage of correct answers of SUBGROUP 1 (male) is {round(success_male, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 1 (male) is {round(lr_F1_male, digits = 3)}")

# SUBGROUP 2: Sex - female
str_glue("The percentage of correct answers of SUBGROUP 2 (female) is {round(success_female, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 2 (female) is {round(lr_F1_female, digits = 3)}")

# SUBGROUP 3: age - 0-9 years   # NO DATA (min age = 17 years old)

# SUBGROUP 4: age - 10-19 years
str_glue("The percentage of correct answers of SUBGROUP 4 (adolescence) is {round(success_adolescence, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 4 (adolescence) is {round(lr_F1_adolescence, digits = 3)}")

# SUBGROUP 5: age - 20-24 years
str_glue("The percentage of correct answers of SUBGROUP 5 (youth) is {round(success_youth, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 5 (youth) is {round(lr_F1_youth, digits = 3)}")

# SUBGROUP 6: age  25-64 years
str_glue("The percentage of correct answers of SUBGROUP 6 (adulthood) is {round(success_adulthood, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 6 (adulthood) is {round(lr_F1_adulthood, digits = 3)}")

# SUBGROUP 7: age - >65 years
str_glue("The percentage of correct answers of SUBGROUP 7 (old_age) is {round(success_old_age, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 7 (old_age) is {round(lr_F1_old_age, digits = 3)}")

# SUBGROUP 8: teachingstatus - 1 (TRUE)
str_glue("The percentage of correct answers of SUBGROUP 8 (teachingstatus 1) is {round(success_teach_true, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 8 (teachingstatus 1) is {round(lr_F1_teach_true, digits = 3)}")

# SUBGROUP 9: teachingstatus - 0 (FALSE)
str_glue("The percentage of correct answers of SUBGROUP 9 (teachingstatus 0) is {round(success_teach_false, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 9 (teachingstatus 0) is {round(lr_F1_teach_false, digits = 3)}")

# SUBGROUP 10: ethnicity - 0 (African American)
str_glue("The percentage of correct answers of SUBGROUP 10 (African American) is {round(success_african_american, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 10 (African American) is {round(lr_F1_african_american, digits = 3)}")

# SUBGROUP 11: ethnicity - 1 (Asian)
str_glue("The percentage of correct answers of SUBGROUP 11 (Asian) is {round(success_asian, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 11 (Asian) is {round(lr_F1_asian, digits = 3)}")

# SUBGROUP 12: ethnicity - 2 (Caucasian)
str_glue("The percentage of correct answers of SUBGROUP 12 (Caucasian) is {round(success_caucasian, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 12 (Caucasian) is {round(lr_F1_caucasian, digits = 3)}")

# SUBGROUP 13: ethnicity - 3 (Hispanic)
str_glue("The percentage of correct answers of SUBGROUP 13 (Hispanic) is {round(success_hispanic, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 13 (Hispanic) is {round(lr_F1_hispanic, digits = 3)}")

# SUBGROUP 14: ethnicity - 4 (Native American)
str_glue("The percentage of correct answers of SUBGROUP 14 (Native American) is {round(success_native_american, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 14 (Native American) is {round(lr_F1_native_american, digits = 3)}")

# SUBGROUP 15: ethnicity - 5 (Other ethnicity)
str_glue("The percentage of correct answers of SUBGROUP 15 (Other ethnicity) is {round(success_ethnicity_other, digits = 3)} %")
str_glue("lr model F1 of SUBGROUP 15 (Other ethnicity) is {round(lr_F1_ethnicity_other, digits = 3)}")

```

## Comparative table Option B

```{r}

# UPLOAD THE MODELS (Not needed if you have run all the code)

fit_lr_male <- readRDS("lr_male_model.Rda")
fit_lr_female <- readRDS("lr_female_model.Rda")
fit_lr_adolescence <- readRDS("lr_adolescence_model.Rda")
fit_lr_youth <- readRDS("lr_youth_model.Rda")
fit_lr_adulthood <- readRDS("lr_adulthood_model.Rda")
fit_lr_old_age <- readRDS("lr_old_age_model.Rda")
fit_lr_teach_true <- readRDS("lr_teach_true_model.Rda")
fit_lr_teach_false <- readRDS("lr_teach_false_model.Rda")
fit_lr_african_american <- readRDS("lr_african_american_model.Rda")
fit_lr_asian <- readRDS("lr_asian_model.Rda")
fit_lr_caucasian <- readRDS("lr_caucasian_model.Rda")
fit_lr_hispanic <- readRDS("lr_hispanic_model.Rda")
fit_lr_native_american <- readRDS("lr_native_american_model.Rda")
fit_lr_ethnicity_other <- readRDS("lr_ethnicity_other_model.Rda")

# Before executing the following code it is necessary to execute the prediction section of each SUBGROUP.

# PARAMETER F1.

lr_F1_male <-F1_Score(final_predictions_lr_male$obs, final_predictions_lr_male$pred)
lr_F1_female <-F1_Score(final_predictions_lr_female$obs, final_predictions_lr_female$pred)
lr_F1_adolescence <-F1_Score(final_predictions_lr_adolescence$obs, final_predictions_lr_adolescence$pred)
lr_F1_youth <-F1_Score(final_predictions_lr_youth$obs, final_predictions_lr_youth$pred)
lr_F1_adulthood<-F1_Score(final_predictions_lr_adulthood$obs, final_predictions_lr_adulthood$pred)
lr_F1_old_age <-F1_Score(final_predictions_lr_old_age$obs, final_predictions_lr_old_age$pred)
lr_F1_teach_true <-F1_Score(final_predictions_lr_teach_true$obs, final_predictions_lr_teach_true$pred)
lr_F1_teach_false <-F1_Score(final_predictions_lr_teach_false$obs, final_predictions_lr_teach_false$pred)
lr_F1_african_american <-F1_Score(final_predictions_lr_african_american$obs, final_predictions_lr_african_american$pred)
lr_F1_asian <-F1_Score(final_predictions_lr_asian$obs, final_predictions_lr_asian$pred)
lr_F1_caucasian <-F1_Score(final_predictions_lr_caucasian$obs, final_predictions_lr_caucasian$pred)
lr_F1_hispanic <-F1_Score(final_predictions_lr_hispanic$obs, final_predictions_lr_hispanic$pred)
lr_F1_native_american <-F1_Score(final_predictions_lr_native_american$obs, final_predictions_lr_native_american$pred)
lr_F1_ethnicity_other <-F1_Score(final_predictions_lr_ethnicity_other$obs, final_predictions_lr_ethnicity_other$pred)

# PERCENTAGE (%) OF SUCCESS

success_male <- mean(final_predictions_male$obs == final_predictions_male$pred)*100
success_female <- mean(final_predictions_female$obs == final_predictions_female$pred)*100
success_adolescence <- mean(final_predictions_adolescence$obs == final_predictions_adolescence$pred)*100
success_youth <- mean(final_predictions_youth$obs == final_predictions_youth$pred)*100
success_adulthood <- mean(final_predictions_adulthood$obs == final_predictions_adulthood$pred)*100
success_old_age <- mean(final_predictions_old_age$obs == final_predictions_old_age$pred)*100
success_teach_true <- mean(final_predictions_teach_true$obs == final_predictions_teach_true$pred)*100
success_teach_false <- mean(final_predictions_teach_false$obs == final_predictions_teach_false$pred)*100
success_african_american <- mean(final_predictions_african_american$obs == final_predictions_african_american$pred)*100
success_asian <- mean(final_predictions_asian$obs == final_predictions_asian$pred)*100
success_caucasian <- mean(final_predictions_caucasian$obs == final_predictions_caucasian$pred)*100
success_hispanic <- mean(final_predictions_hispanic$obs == final_predictions_hispanic$pred)*100
success_native_american <- mean(final_predictions_native_american$obs == final_predictions_native_american$pred)*100
success_ethnicity_other <- mean(final_predictions_ethnicity_other$obs == final_predictions_ethnicity_other$pred)*100

#-------------------------------------------------------------------------------

# CREATE THE TABLE

# Models
Groups <- c("Male", "Female", "Adolescence", "Youth", "Adulthood", "Old Age", "Teach True", "Teach False", "African American", "Asian", "Caucasian", "Hispanic", "Native American", "Ethnicity Other")

# Precision
Precision <- round(c(m1_Precision, m2_Precision, m4_Precision, m5_Precision, m6_Precision, m7_Precision, m8_Precision, m9_Precision, m10_Precision, m11_Precision, m12_Precision, m13_Precision, m14_Precision, m15_Precision),3)

# Recall
Recall <- round(c(m1_recall, m2_recall, m4_recall, m5_recall, m6_recall, m7_recall, m8_recall, m9_recall, m10_recall, m11_recall, m12_recall, m13_recall, m14_recall, m15_recall),3)

# F1 parameter
F1 <- round(c(lr_F1_male, lr_F1_female, lr_F1_adolescence, lr_F1_youth, lr_F1_adulthood, lr_F1_old_age, lr_F1_teach_true, lr_F1_teach_false, lr_F1_african_american, lr_F1_asian, lr_F1_caucasian, lr_F1_hispanic, lr_F1_native_american, lr_F1_ethnicity_other),3)


# Dataframe
comparative_option_B <- data.frame(Groups = Groups, Precision = Precision, Recall = Recall, F1 = F1)

print(comparative_option_B)

```

